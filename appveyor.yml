version: configuring.{build}
configuration:
- Release
- Debug
platform:
- Win32
- x64
clone_folder: c:\SLBuild\cabl
init:
- cmd: choco install doxygen.install
build_script:
- cmd: >-
    echo Running cmake...

    echo Building %CONFIGURATION% - %PLATFORM%

    cd c:\SLBuild\cabl

    mkdir build-%PLATFORM%

    pushd build-%PLATFORM%

    if %PLATFORM% == x64 (cmake -G "Visual Studio 14 2015 Win64" -DBUILD_STATIC_LIBS=ON -DBUILD_SHARED_LIBS=ON ..) else (cmake -DBUILD_STATIC_LIBS=ON -DBUILD_SHARED_LIBS=ON ..)

    cd ..

    cmake --build build-%PLATFORM% --config %CONFIGURATION%

    if %PLATFORM% == x64 (ren build-%PLATFORM%/%CONFIGURATION%/cabl* build-%PLATFORM%/%CONFIGURATION%/cabl-64*)
before_test:
- cmd: >-
    cd c:\SLBuild\cabl\build-%PLATFORM%\test\%CONFIGURATION%\

    unit-tests.exe -s -r junit -o test-report.junit.xml
after_test:
- ps: >-
    # upload results to AppVeyor

    $wc = New-Object 'System.Net.WebClient'

    $wc.UploadFile("https://ci.appveyor.com/api/testresults/junit/$($env:APPVEYOR_JOB_ID)", (Resolve-Path c:\SLBuild\cabl\build-$($env:PLATFORM)\test\$($env:CONFIGURATION)\test-report.junit.xml))
artifacts:
- path: build-Win32/$(CONFIGURATION)/cabl.lib
  name: cabl (static - 32bit)
- path: build-Win32/$(CONFIGURATION)/cabl.dll
  name: cabl (dll - 32bit)
- path: build-x64/$(CONFIGURATION)/cabl-x64.lib
  name: cabl (static - 64bit)
- path: build-x64/$(CONFIGURATION)/cabl-x64.lib
  name: cabl (dll - 64bit)
- path: inc
  name: include
deploy:
- provider: Environment
  name: cabl-win-x64
  on:
    branch: develop
    CONFIGURATION: Release
    PLATFORM: x64
- provider: Environment
  name: cabl-win-x86
  on:
    branch: develop
    CONFIGURATION: Release
    PLATFORM: Win32
